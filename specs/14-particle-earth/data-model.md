# Data Model: Particle Earth Sphere

**Feature**: 14-particle-earth  
**Date**: 2025-12-01  
**Source**: [spec.md](./spec.md), [research.md](./research.md)

## Entities

### 1. ParticleSystem

核心粒子系統實體，管理所有粒子的位置和渲染。

| 屬性 | 型別 | 說明 | 約束 |
|------|------|------|------|
| numParticles | number | 粒子總數 | 50,000 (固定) |
| radius | number | 球體半徑 | 預設 200 |
| positions | Float32Array | 粒子位置陣列 | length = numParticles * 3 |
| geometry | BufferGeometry | Three.js 幾何體 | - |
| material | ShaderMaterial | 自訂著色器材質 | - |
| mesh | Points | Three.js 點雲物件 | - |

### 2. ShaderUniforms

著色器統一變數，控制視覺效果。

| 屬性 | 型別 | 說明 | 預設值 | 範圍 |
|------|------|------|--------|------|
| map | Texture | 地球紋理貼圖 | - | - |
| pointSize | number | 粒子大小 | 2.0 | 1.0 - 10.0 |
| opacity | number | 透明度 | 0.8 | 0.0 - 1.0 |
| time | number | 動畫時間 | 0.0 | 累加 |
| rotationSpeed | number | 自轉速度 | 0.001 | 0.0 - 0.01 |

### 3. CameraController

攝影機控制器，管理視角互動。

| 屬性 | 型別 | 說明 | 預設值 |
|------|------|------|--------|
| camera | PerspectiveCamera | Three.js 攝影機 | - |
| targetPosition | Vector3 | 目標位置 | (0, 0, 0) |
| currentPosition | Vector3 | 當前位置 | (0, 0, 500) |
| center | Vector3 | 注視中心點 | (0, 0, 0) |
| sensitivity | number | 滑鼠敏感度 | 0.5 |
| dampingFactor | number | 阻尼因子 | 0.05 |
| isMouseInWindow | boolean | 滑鼠是否在視窗內 | true |

### 4. AppState

應用程式全域狀態。

| 屬性 | 型別 | 說明 |
|------|------|------|
| scene | Scene | Three.js 場景 |
| renderer | WebGLRenderer | WebGL 渲染器 |
| particleSystem | ParticleSystem | 粒子系統實例 |
| cameraController | CameraController | 攝影機控制器實例 |
| gui | GUI | lil-gui 控制面板 |
| isRunning | boolean | 動畫是否執行中 |

## Data Flow

```
┌─────────────────────────────────────────────────────────────────┐
│                        Application Init                          │
└─────────────────────────────────────────────────────────────────┘
                                │
                                ▼
┌─────────────────────────────────────────────────────────────────┐
│  1. 建立 Scene, Camera, Renderer                                 │
└─────────────────────────────────────────────────────────────────┘
                                │
                                ▼
┌─────────────────────────────────────────────────────────────────┐
│  2. 載入地球紋理 (TextureLoader)                                  │
└─────────────────────────────────────────────────────────────────┘
                                │
                                ▼
┌─────────────────────────────────────────────────────────────────┐
│  3. 生成斐波那契球面分布座標 (50,000 points)                       │
│     - 計算每個粒子的 (x, y, z) 位置                               │
│     - 儲存至 Float32Array                                        │
└─────────────────────────────────────────────────────────────────┘
                                │
                                ▼
┌─────────────────────────────────────────────────────────────────┐
│  4. 建立 BufferGeometry + ShaderMaterial                         │
│     - 設定 position attribute                                    │
│     - 編譯頂點/片段著色器                                         │
│     - 設定 uniforms                                              │
└─────────────────────────────────────────────────────────────────┘
                                │
                                ▼
┌─────────────────────────────────────────────────────────────────┐
│  5. 建立 Points mesh 並加入 Scene                                 │
└─────────────────────────────────────────────────────────────────┘
                                │
                                ▼
┌─────────────────────────────────────────────────────────────────┐
│  6. 設定事件監聽器                                                │
│     - mousemove: 更新目標攝影機位置                               │
│     - mouseleave: 設定返回預設位置                                │
│     - resize: 更新渲染器和攝影機                                  │
└─────────────────────────────────────────────────────────────────┘
                                │
                                ▼
┌─────────────────────────────────────────────────────────────────┐
│  7. 啟動動畫迴圈 (requestAnimationFrame)                          │
└─────────────────────────────────────────────────────────────────┘
```

## Animation Loop Data Flow

```
┌─────────────────────────────────────────────────────────────────┐
│                    animate() - 每幀執行                          │
└─────────────────────────────────────────────────────────────────┘
                                │
        ┌───────────────────────┼───────────────────────┐
        ▼                       ▼                       ▼
┌───────────────┐     ┌───────────────┐     ┌───────────────┐
│ 更新 time     │     │ 更新攝影機    │     │ 渲染場景      │
│ uniform       │     │ 位置 (lerp)   │     │               │
└───────────────┘     └───────────────┘     └───────────────┘
        │                       │                       │
        ▼                       ▼                       ▼
┌───────────────┐     ┌───────────────┐     ┌───────────────┐
│ 地球自轉      │     │ camera.lookAt │     │ renderer.     │
│ (rotation.y)  │     │ (center)      │     │ render()      │
└───────────────┘     └───────────────┘     └───────────────┘
```

## State Transitions

### Mouse State Machine

```
                    ┌─────────────────┐
                    │   IDLE          │
                    │ (預設位置)       │
                    └────────┬────────┘
                             │ mousemove
                             ▼
                    ┌─────────────────┐
                    │   FOLLOWING     │
                    │ (跟隨滑鼠)      │◄────┐
                    └────────┬────────┘     │
                             │              │ mousemove
                             │              │
              mouseleave     │              │
                             ▼              │
                    ┌─────────────────┐     │
                    │   RETURNING     │─────┘
                    │ (返回預設)      │ mouseenter
                    └────────┬────────┘
                             │ position ≈ default
                             ▼
                    ┌─────────────────┐
                    │   IDLE          │
                    └─────────────────┘
```

## Validation Rules

| 規則 | 說明 |
|------|------|
| VR-001 | numParticles 必須為正整數 |
| VR-002 | radius 必須為正數 |
| VR-003 | pointSize 範圍 1.0 - 10.0 |
| VR-004 | rotationSpeed 範圍 0.0 - 0.01 |
| VR-005 | opacity 範圍 0.0 - 1.0 |
| VR-006 | 紋理必須成功載入後才能開始渲染 |
