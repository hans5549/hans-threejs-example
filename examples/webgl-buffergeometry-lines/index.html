<!DOCTYPE html>
<html lang="en">
	<head>
		<title>three.js webgl - buffergeometry - lines</title>
		<meta charset="utf-8">
		<meta name="viewport" content="width=device-width, user-scalable=no, minimum-scale=1.0, maximum-scale=1.0">
		<link type="text/css" rel="stylesheet" href="../../favicon.svg">
		<style>
			body {
				margin: 0;
				background-color: #000;
				color: #fff;
				font-family: Monospace;
				font-size: 13px;
				line-height: 24px;
				overscroll-behavior: none;
			}

			#container {
				width: 100%;
				height: 100vh;
			}

			#info {
				position: absolute;
				top: 0px;
				width: 100%;
				padding: 10px;
				box-sizing: border-box;
				text-align: center;
				-moz-user-select: none;
				-webkit-user-select: none;
				-ms-user-select: none;
				user-select: none;
				pointer-events: none;
				z-index: 1;
			}

			a {
				color: #ff0;
				pointer-events: auto;
			}

			.fallback {
				display: flex;
				flex-direction: column;
				align-items: center;
				justify-content: center;
				height: 100%;
				text-align: center;
				padding: 20px;
				box-sizing: border-box;
			}

			.fallback img {
				max-width: 80%;
				max-height: 60%;
				border: 2px solid #333;
				border-radius: 8px;
			}

			.fallback p {
				margin-top: 20px;
				color: #999;
				max-width: 600px;
			}
		</style>
	</head>
	<body>

		<div id="container"></div>
		<div id="info">
			<a href="https://threejs.org" target="_blank" rel="noopener">three.js</a> webgl - buffergeometry - lines
		</div>

		<script type="importmap">
			{
				"imports": {
					"three": "https://cdn.jsdelivr.net/npm/three@0.174.0/build/three.module.js",
					"three/addons/": "https://cdn.jsdelivr.net/npm/three@0.174.0/examples/jsm/"
				}
			}
		</script>

		<script type="module">

			import * as THREE from 'three';
			import Stats from 'three/addons/libs/stats.module.js';

			// 全域變數
			let container, camera, scene, renderer, stats;
			let line, clock;
			let t = 0;

			// 常數
			const segments = 10000;
			const r = 800;

			// 初始化
			init();

			function init() {

				// 取得容器元素
				container = document.getElementById( 'container' );

				// 建立透視相機 (T009)
				camera = new THREE.PerspectiveCamera( 27, window.innerWidth / window.innerHeight, 1, 4000 );
				camera.position.z = 2750;

				// 建立場景 (T010)
				scene = new THREE.Scene();

				// 初始化 Clock（替代 Timer，相容性更好）
				clock = new THREE.Clock();

				// 建立 BufferGeometry (T011)
				const geometry = new THREE.BufferGeometry();

				// 產生頂點位置和顏色 (T011, T012)
				const positions = [];
				const colors = [];

				for ( let i = 0; i < segments; i ++ ) {

					// 隨機位置
					const x = Math.random() * r - r / 2;
					const y = Math.random() * r - r / 2;
					const z = Math.random() * r - r / 2;

					positions.push( x, y, z );

					// 根據位置計算顏色 (T012)
					colors.push( ( x / r ) + 0.5 );
					colors.push( ( y / r ) + 0.5 );
					colors.push( ( z / r ) + 0.5 );

				}

				// 設定 BufferAttribute (T013)
				geometry.setAttribute( 'position', new THREE.Float32BufferAttribute( positions, 3 ) );
				geometry.setAttribute( 'color', new THREE.Float32BufferAttribute( colors, 3 ) );

				// 計算 bounding sphere (T015)
				geometry.computeBoundingSphere();

				// 產生 morph targets (T019-T023)
				generateMorphTargets( geometry );

				// 建立材質 (T014)
				const material = new THREE.LineBasicMaterial( { vertexColors: true } );

				// 建立 Line 物件並加入場景 (T015)
				line = new THREE.Line( geometry, material );
				scene.add( line );

				// 建立 WebGLRenderer (T016)
				try {

					renderer = new THREE.WebGLRenderer();
					renderer.setPixelRatio( window.devicePixelRatio );
					renderer.setSize( window.innerWidth, window.innerHeight );
					renderer.setAnimationLoop( animate );

					container.appendChild( renderer.domElement );

				} catch ( e ) {

					// WebGL 不支援時顯示 fallback (T007)
					showFallback();
					return;

				}

				// 建立 Stats 面板 (T026, T027)
				stats = new Stats();
				container.appendChild( stats.dom );

				// 註冊 resize 事件 (T032)
				window.addEventListener( 'resize', onWindowResize );

			}

			// 產生 morph targets (T019-T022)
			function generateMorphTargets( geometry ) {

				const data = [];

				for ( let i = 0; i < segments; i ++ ) {

					data.push(
						Math.random() * r - r / 2,
						Math.random() * r - r / 2,
						Math.random() * r - r / 2
					);

				}

				const morphTarget = new THREE.Float32BufferAttribute( data, 3 );
				morphTarget.name = 'target1';

				geometry.morphAttributes.position = [ morphTarget ];

			}

			// 動畫迴圈 (T017, T018)
			function animate() {

				// 取得時間資訊
				const delta = clock.getDelta();
				const time = clock.getElapsedTime();

				// 旋轉動畫 (T017)
				line.rotation.x = time * 0.25;
				line.rotation.y = time * 0.5;

				// Morph 動畫 (T024, T025)
				t += delta * 0.5;
				line.morphTargetInfluences[ 0 ] = Math.abs( Math.sin( t ) );

				// 渲染
				renderer.render( scene, camera );

				// 更新 Stats (T028)
				stats.update();

			}

			// 視窗調整處理 (T029-T031)
			function onWindowResize() {

				camera.aspect = window.innerWidth / window.innerHeight;
				camera.updateProjectionMatrix();

				renderer.setSize( window.innerWidth, window.innerHeight );

			}

			// WebGL fallback (T007, T008)
			function showFallback() {

				container.innerHTML = `
					<div class="fallback">
						<img src="fallback.svg" alt="WebGL BufferGeometry Lines 展示">
						<p>您的瀏覽器不支援 WebGL。請使用現代瀏覽器（Chrome, Firefox, Safari, Edge）以獲得最佳體驗。</p>
					</div>
				`;

			}

		</script>

	</body>
</html>
